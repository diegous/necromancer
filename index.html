<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Necromancer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js" onload="window.$ = window.jQuery = module.exports;"></script>
    <script type="text/javascript" src="./js/databaseLoader.js"></script>
    <script type="text/javascript" src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  </head>
  <body>

    <div>
      <h1>Cargar archivos desde carpeta</h1>
      <button id="loadButton" class="btn">Abrir directorio</button>
    </div>

    <!-- Added files Modal -->
    <div class="modal fade" id="addedFilesModal" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Archivos Agregados</h4>
          </div>
          <div class="modal-body">
            <h2>Archivos agregados exitosamente:</h2>
            <h2 id="totalAddedFiles">0</h2>

            <div id="notAddedFilesTable" class="invisible">
              <h4>Algunos archivos no pudieron ser agregados:</h4>
              <table class="table table-hover">
                <thead>
                  <th>Nombre</th>
                  <th>Protocolo</th>
                  <th>Error</th>
                </thead>
                <tbody id="notAddedFilesList"></tbody>
              </table>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>

    <div>
      <h1>Archivos guardados</h1>

      <table id="filesTable" class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Protocolo</th>
            <th>Nombre del Paciente</th>
            <th>Edad</th>
            <th>Medico Solicitante</th>
            <th>Obra Social</th>
            <th>Material Remitido</th>
            <th>Descripcion Citologica</th>
            <th>Diagnostico Oncologico</th>
            <th>Fecha</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  <script>

    const fs = require('fs')
    const parseFile = require('./js/ParseFile')
    const dialog = require('electron').remote.dialog
    const loadButton = document.getElementById('loadButton')
    const totalAddedFilesText = document.getElementById('totalAddedFiles')
    const notAddedFilesList = document.getElementById('notAddedFilesList');
    const errorsTable = document.getElementById('notAddedFilesTable');
    const tableBody = document.getElementById('tableBody')

    loadButton.onclick = function () {
      dialog.showOpenDialog({ properties: ['openDirectory'] }, function (paths) {
        let dirPath = paths[0]
        let encoding = 'CP437'
        let Iconv = require('iconv').Iconv;
        let iconv = new Iconv(encoding, 'UTF-8')

        fs.readdir(dirPath, function (err, files) {
          if (err) return;
          let totalAddedFiles = {total: 0};
          let filesNotSaved = [];
          errorsTable.classList.add("invisible");

          files.forEach( function (fileName) {
            // I don't know if this '/' will work on Window$ since it uses '\' for dirs
            let filePath = dirPath +'/'+ fileName

            fs.readFile(filePath, function (err, data) {
              if (err) return;

              var buffer = iconv.convert(data)
              var fileContent = buffer.toString('utf8')

              var newFile = parseFile(fileContent)
              newFile.fileName = fileName

              // save newFile in database
              addFileToDB(newFile, totalAddedFiles);
            })
          })

          $('#addedFilesModal').modal();
        })
      })
    }

    var addFileToDB = (newFile, totalAddedFiles) => {
      db.files.add({
        protocol:        newFile.protocol,
        patientName:     newFile.patientName,
        patientAge:      newFile.patientAge,
        doctorName:      newFile.doctorName,
        insuranceCompay: newFile.insuranceCompay,
        material:        newFile.material,
        reportType:      newFile.reportType,
        description:     newFile.description,
        diagnosis:       newFile.diagnosis,
        date:            newFile.date,
        fileName:        newFile.fileName,
      }).then(file => {
        totalAddedFilesText.innerHTML = ++(totalAddedFiles.total);
        addFileToTable(newFile);
      }).catch(function(error) {
        let tableRow = notAddedFilesList.insertRow()
        let addCell = cellInserterForTableRow(tableRow)
        errorsTable.classList.remove("invisible");

        addCell(newFile.fileName);
        addCell(newFile.protocol);
        addCell(error);
        // filesNotSaved.push({fileName: newFile.fileName, protocol: newFile.protocol, error: error});
      });
    }

    var cellInserterForTableRow = function (row) {
      return text => { row.insertCell().innerHTML = text || "-" }
    }

    Dexie.spawn(function*() {

      db.files.toArray().then(array =>  {
        array.forEach(addFileToTable);
      })
    }).catch (err => {
      console.error ("Error when " + err.stack);
    });

    var addFileToTable = file => {
      let tableRow = tableBody.insertRow(0)

      let addCell = cellInserterForTableRow(tableRow)

      addCell(file.id)
      addCell(file.protocol)
      addCell(file.patientName)
      addCell(file.patientAge)
      addCell(file.doctorName)
      addCell(file.insuranceCompay)
      addCell(file.material)
      addCell(file.description)
      addCell(file.diagnosis)
      addCell(file.date)
      addCell(file.fileNumber)
    }

  </script>
</html>
